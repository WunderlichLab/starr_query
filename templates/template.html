<!DOCTYPE html>
<html>
    <head>
        <title>Large-scale Enhancer Screen Database</title>

        <!--  custom CSS -->
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='design.css') }}">

        <!-- DataTables core CSS -->
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">

        <!-- Buttons extension CSS -->
        <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
    </head>
  
    <body>
        <!-- Division for header and logo -->
       	<div>
            <div class="header">
                <h1 id="title">Large-scale Enhancer Screen Database</h1>
                <a href="https://wunderlichlab.mystrikingly.com/"><img src="{{ url_for('static', filename='images/wunderlich_lab_clear.png') }}" class="logo" alt="Logo"></a>
            </div>
        </div>
        <!-- Tabs -->
        <div class="tabs">

            <div class="tab active" data-target="#introduction"><b>Introduction</b></div>
            <div class="tab"        data-target="#region-search"><b>Search by Proximity</b></div>
            <div class="tab"        data-target="#gene-search"><b>Search by Genes</b></div>
            <div class="tab"        data-target="#activity-search"><b>Search by Activity Info</b></div>
        </div>

        <!-- Introduction -->
        <div id="introduction" class="tab-content active">
            <h2>Drosophila Immune Enhancer Atlas</h2>

            <div style="background-color: #f0f8ff; padding: 1.5rem; border-left: 4px solid #5f9ea0; margin-bottom: 2rem;">
                <h3 style="margin-top: 0;">About This Resource</h3>
                <p><strong>Citation:</strong> Cohen, L.B., Hadzic, T., Sauer, C., Gibbs, J.R., & Wunderlich, Z. (2025).
                <em>A genome-wide survey reveals a diverse array of enhancers coordinate the Drosophila innate immune response</em>.
                bioRxiv. <a href="https://doi.org/10.1101/2025.09.24.678314" target="_blank">https://doi.org/10.1101/2025.09.24.678314</a></p>

                <details style="margin-top: 1rem;">
                    <summary style="cursor: pointer; font-weight: bold; color: #5f9ea0;">Show Abstract</summary>
                    <p style="margin-top: 1rem; text-align: justify;">
                        To defend against microbes, animals regulate a complex immune response. The <em>Drosophila</em> innate immune
                        system deploys a large transcriptional induction of signaling proteins, anti-microbial effectors, and other
                        critical immune factors. This transcriptional response is encoded in enhancers, cis-regulatory sequences that
                        modulate gene expression by binding transcription factors (TFs). While enhancers and transcription factor
                        binding sites (TFBS) have been identified for several immune responsive genes in <em>Drosophila</em>, most
                        enhancers that regulate immune-induced genes are unknown. By identifying enhancers, we can understand how
                        their composition controls expression and contributes to infection outcome. We employed STARR-seq
                        (Self Transcribing Active Regulatory-Region sequencing) in a hemocyte-like cell line to identify
                        immune-specific enhancers across the <em>D. melanogaster</em> genome and performed ATAC-seq in hemocytes
                        extracted from adult flies to assess the chromatin state of these enhancers before and after immune stimulus.
                        We identified thousands of enhancers responsive to IMD stimulation, one of the two primary immune signaling
                        pathways in <em>Drosophila</em>. As expected, immune enhancers are enriched for motifs of Relish, an NF-κB
                        factor, and Kay/Jra, a bZip heterodimer pair, involved in the Imd and JNK pathways respectively, compared
                        to enhancers active in unstimulated cells. However, when grouping enhancers by their target gene's expression
                        timing or functional role or by the enhancers' chromatin accessibility pre- or post-stimulus, different groups
                        of TFBS motifs are enriched, suggesting distinct regulatory logic for different parts of the immune response.
                        Identification and characterization of the diverse array of enhancers that regulate the innate immune response
                        expands our understanding of how animals fight infections.
                    </p>
                </details>
            </div>

            <p id="description">
                This is the Wunderlich Lab's web platform for querying and visualizing enhancer–gene associations using STARR-seq
                datasets from <i>Drosophila melanogaster</i>. The database helps researchers explore how enhancers regulate gene
                expression across different experimental conditions (Control, 20E hormone treatment, and HKSM immune treatment).
            </p>

            <h3>What This Website Does</h3>
            <p>
                The Large-Scale Enhancer Database integrates high-throughput STARR-seq data with
                gene expression and functional annotations. It allows you to:
            </p>
            <ul>
                <li><strong>Search by enhancer location:</strong> Find all genes regulated by
                    enhancers in a specific chromosomal region</li>
                <li><strong>Search by gene:</strong> Discover all enhancers that regulate a
                    particular gene across experimental conditions</li>
                <li><strong>Search by activity profile:</strong> Filter enhancers based on
                    activity class, accessibility, immune function, and temporal gene expression patterns</li>
                <li><strong>Apply comprehensive filters:</strong> Refine results by activity scores,
                    experimental conditions, time clusters, and immune process annotations</li>
                <li><strong>Export results:</strong> Download results in CSV, TSV, or Excel formats for
                    further analysis</li>
            </ul>

            <h3>How to Use This Database</h3>

            <div class="info-boxes">
                <div class="info-box" id="enhancerToGeneBox">
                    <h4>Enhancer → Gene</h4>
                    <p>
                        <strong>Use case:</strong> You have enhancer coordinates and want to find regulated genes<br><br>
                        <strong>Steps:</strong>
                    </p>
                    <ol>
                        <li>Go to the <strong>"Search by Proximity"</strong> tab</li>
                        <li>Enter the chromosome (2L, 2R, 3L, 3R, X, Y, or 4)</li>
                        <li>Enter the enhancer start and end positions</li>
                        <li>Optionally filter by activity score, condition, time cluster, or immune process</li>
                        <li>Click "Submit" to see all genes within 15kb of your enhancer region</li>
                        <li>Download results in your preferred format (CSV, TSV, XLSX)</li>
                    </ol>
                    <p><strong>Output:</strong> A sortable table with gene symbols, enhancer IDs, TPM values, immune annotations, and direct links to UCSC Genome Browser.</p>
                </div>

                <div class="info-box" id="geneToEnhancerBox">
                    <h4>Gene → Enhancer</h4>
                    <p>
                        <strong>Use case:</strong> You have a gene of interest and want to find its regulatory enhancers<br><br>
                        <strong>Steps:</strong>
                    </p>
                    <ol>
                        <li>Go to the <strong>"Search by Genes"</strong> tab</li>
                        <li>Enter either a gene symbol (e.g., "Abd-B") or FlyBase ID (e.g., "FBgn0000015")</li>
                        <li>Set an activity score threshold (default: 500)</li>
                        <li>Optionally filter by condition, time cluster, or immune process</li>
                        <li>Click "Submit" to find all enhancers regulating your gene</li>
                        <li>Download the results table</li>
                    </ol>
                    <p><strong>Output:</strong> A table of enhancers with activity scores, accessibility information, distance to gene, and genomic coordinates with browser links.</p>
                </div>

                <div class="info-box">
                    <h4>Activity Class Search</h4>
                    <p>
                        <strong>Use case:</strong> You want to find enhancers with specific regulatory properties<br><br>
                        <strong>Steps:</strong>
                    </p>
                    <ol>
                        <li>Go to the <strong>"Search by Activity Info"</strong> tab</li>
                        <li>Select desired filters: activity class, accessibility, time cluster, or immune process</li>
                        <li>At least one filter is required</li>
                        <li>Click "Search" to find matching enhancers and their target genes</li>
                    </ol>
                    <p><strong>Output:</strong> A comprehensive table showing enhancers grouped by activity class, with associated genes and functional annotations.</p>
                </div>
            </div>

            <h3>About the Data</h3>
            <p>The database contains datasets from three experimental conditions:</p>
            <ul>
                <li><strong>Control:</strong> Baseline conditions</li>
                <li><strong>20E:</strong> hormone treatment</li>
                <li><strong>HKSM:</strong> Heat-killed <i>S. marcescens</i> with 20E treatment</li>
            </ul>

            <p>Each entry includes:</p>
            <ul>
                <li>Genomic coordinates of consensus enhancer regions</li>
                <li>Genes found within 5kb upstream and 15 kb downstream of each enhancer</li>
                <li>Gene expression levels (TPM values) across conditions</li>
                <li>Enhancer activity scores from STARR-seq assays</li>
                <li>Accessibility information (ATAC-seq derived)</li>
                <li>Gene annotations: immune pathway, time cluster classification, and distance to enhancer</li>
                <li>Transcription factor motifs and binding site counts</li>
            </ul>

            <h3>Activity Class Distribution</h3>
            <div style="text-align: center; margin: 2rem 0;">
                <img src="{{ url_for('static', filename='images/activity_class_venn.png') }}"
                     alt="Venn Diagram showing enhancer activity class distribution"
                     style="max-width: 50%; height: auto; border: 1px solid #ddd; border-radius: 8px; padding: 1rem;">
                <p style="font-size: 0.9em; color: #666; margin-top: 0.5rem;">
                    Distribution of enhancers across different activity classes. Overlapping regions show enhancers
                    active in multiple conditions.
                </p>
            </div>

            <h3>Tips for Effective Searching</h3>
            <ul>
                <li><strong>Sorting:</strong> Click table headers to sort by any column</li>
                <li><strong>Filtering:</strong> Use the search box in tables to filter by text</li>
                <li><strong>Activity scores:</strong> Higher scores indicate stronger enhancer activity</li>
                <li><strong>Combinations:</strong> You can combine multiple filters for more specific queries</li>
            </ul>

            <h3>Questions or Issues?</h3>
            <p>For questions about this database or the underlying data, please contact the Wunderlich Lab.</p>

            <h3>Acknowledgements</h3>
            <p>This database was created for and with data provided by the Wunderlich Lab. We thank Dr. Zeba Wunderlich and Dr. Lianne Cohen for their support and guidance.</p>
            <p>This website was created by Anushka Dongaonkar, Yuki Ito, Gary Twu, and Jahnavi Kodali as part of the course BF768 Biological Database Analysis at Boston University, facilitated by Dr. Gary Benson.</p>
        </div>


        <!-- Tab1 -->
        <div id="region-search" class="tab-content">
            <h4>Search by chromosomal region OR enhancer name</h4>
            <p style="font-size: 0.9em; color: #666;">Example coordinates: 2L, start: 10426653, end: 10427192 | Example enhancer: 2L:484243-485063</p>

            <form id="enhancer-form" action="{{ url_for('find_gene') }}" method="POST">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <label>
                        Chromosome:<br>
                        <select name="chr" id="enhancer_chr">
                            <option value="">-- Select --</option>
                            <option value="2L">2L</option>
                            <option value="2R">2R</option>
                            <option value="3L">3L</option>
                            <option value="3R">3R</option>
                            <option value="4">4</option>
                            <option value="X">X</option>
                            <option value="Y">Y</option>
                        </select>
                    </label>

                    <label>
                        Start:<br>
                        <input type="number" id="enhancer_start" name="start" placeholder="e.g., 10426653">
                    </label>

                    <label>
                        End:<br>
                        <input type="number" id="enhancer_end" name="end" placeholder="e.g., 10427192">
                    </label>
                </div>

                <div style="margin: 1rem 0; text-align: center; font-weight: bold; color: #666;">
                    - OR -
                </div>

                <div style="margin-bottom: 1rem;">
                    <label>
                        Enhancer Name:<br>
                        <input type="text" name="enhancer_name" id="enhancer_name"
                               placeholder="e.g., 2L:484243-485063"
                               style="width: 100%; max-width: 400px;">
                    </label>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">
                    <label>
                        Min Activity Score:
                        <input type="number" name="activity_score_min" value="0" min="0">
                    </label>

                    <label>
                        Condition:
                        <select name="condition" id="tab1_condition">
                            <option value="">-- All --</option>
                            {% for c in filter_options.conditions %}
                                <option value="{{ c }}">{{ c }}</option>
                            {% endfor %}
                        </select>
                    </label>

                    <label>
                        Time Cluster:
                        <select name="time_cluster" id="tab1_time_cluster">
                            <option value="">-- All --</option>
                            {% for tc in filter_options.time_clusters %}
                                <option value="{{ tc }}">{{ tc }}</option>
                            {% endfor %}
                        </select>
                    </label>

                    <label>
                        Immune Process:
                        <select name="immune_process" id="tab1_immune_process">
                            <option value="">-- All --</option>
                            {% for ip in filter_options.immune_processes %}
                                <option value="{{ ip }}">{{ ip }}</option>
                            {% endfor %}
                        </select>
                    </label>
                </div>

                <button type="submit">Submit</button>
            </form>

            <div id="enhancer-results"></div>
        </div>

        <!-- Tab2 -->
        <div id="gene-search" class="tab-content">
            <h4>Enter a gene (symbol eg "Abd-B" or ID eg "FBgn0000119")</h4>

            <form id="gene-form" action="{{ url_for('find_enhancer') }}" method="POST">
                <div style="display:flex; gap:2rem; margin-bottom:1rem;">
                    <label>
                        Gene Symbol:<br><input type="text" name="symbol" id="gene_symbol">
                    </label>

                    <span style="align-self:center;font-weight:bold;">or</span>

                    <label>
                        Gene ID:<br><input type="text" name="geneid" id="gene_id">
                    </label>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom:1rem;">
                    <label>
                        Activity Score Threshold:
                        <input type="number" name="activity_score" id="tab2_activity_score" value="0" min="0">
                    </label>
                    <label>
                        Condition:
                        <select name="condition" id="tab2_condition">
                            <option value="">-- All --</option>
                            {% for c in filter_options.conditions %}
                                <option value="{{ c }}">{{ c }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <label>
                        Time Cluster:
                        <select name="time_cluster" id="tab2_time_cluster">
                            <option value="">-- All --</option>
                            {% for tc in filter_options.time_clusters %}
                                <option value="{{ tc }}">{{ tc }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <label>
                        Immune Process:
                        <select name="immune_process" id="tab2_immune_process">
                            <option value="">-- All --</option>
                            {% for ip in filter_options.immune_processes %}
                                <option value="{{ ip }}">{{ ip }}</option>
                            {% endfor %}
                        </select>
                    </label>
                </div>

                <button type="submit">Submit</button>
            </form>

            <div id="gene-results"></div>
        </div>

        <!-- Tab3 -->
        <div id="activity-search" class="tab-content">
            <h4>Search enhancers by Activity Class and other filters</h4>

            <form id="activity-form" action="{{ url_for('activity_class_search') }}" method="POST">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <label>
                        Activity Class:
                        <select name="activity_class" id="tab3_activity_class">
                            <option value="">-- Activity Class --</option>
                            {% for ac in filter_options.activity_classes %}
                                <option value="{{ ac }}">{{ ac }}</option>
                            {% endfor %}
                        </select>
                    </label>

                    <label>
                        Accessibility:
                        <select name="accessibility" id="tab3_accessibility">
                            <option value="">-- Accessibility --</option>
                            {% for access in filter_options.accessibilities %}
                                <option value="{{ access }}">{{ access }}</option>
                            {% endfor %}
                        </select>
                    </label>

                    <label>
                        Time Cluster:
                        <select name="time_cluster" id="tab3_time_cluster">
                            <option value="">-- Time Cluster --</option>
                            {% for tc in filter_options.time_clusters %}
                                <option value="{{ tc }}">{{ tc }}</option>
                            {% endfor %}
                        </select>
                    </label>

                    <label>
                        Broad Immune Role:
                        <select name="broad_immune_role" id="tab3_broad_immune_role">
                            <option value="">-- Broad Immune Role --</option>
                            {% for bir in filter_options.broad_immune_roles %}
                                <option value="{{ bir }}">{{ bir }}</option>
                            {% endfor %}
                        </select>
                    </label>
                </div>

                <button type="submit">Search</button>
                <button type="reset" style="margin-left: 1rem;">Clear Filters</button>
            </form>

            <div id="activity-results" style="margin-top: 2rem;"></div>
        </div>

        <!-- JS Libraries -->
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
        <script src="https://www.gstatic.com/charts/loader.js"></script>

        <script>
            $(function(){
                // Tab switching
                $('.tab').click(function(){
                    $('.tab').removeClass('active');
                    $(this).addClass('active');
                    $('.tab-content').removeClass('active');
                    const target = $($(this).data('target'));
                    target.addClass('active');
                    $('html, body').animate({ scrollTop: 0 }, 600);
                });

                // Tab 1: Enhancer→Gene
                $('#enhancer-form').submit(function(e){
                    e.preventDefault();
                    $.post(this.action, $(this).serialize())
                    .done(html => {
                        $('#enhancer-results').html(html);

                        if ($.fn.DataTable.isDataTable('#geneTable')) {
                            $('#geneTable').DataTable().destroy();
                        }

                        $('#geneTable').DataTable({
                            dom: 'Blfrtip',
                            buttons: [
                                {
                                    extend: 'csvHtml5',
                                    title: function() {
                                        const chr = $('#enhancer_chr').val() || 'All';
                                        const enh = $('#enhancer_name').val() || '';
                                        const condition = $('#tab1_condition').val() || 'All';
                                        const name = enh || `${chr}_Region`;
                                        return `Enhancers_${name}_${condition}_${new Date().toISOString().split('T')[0]}`;
                                    }
                                },
                                {
                                    extend: 'csvHtml5',
                                    text: 'TSV',
                                    fieldSeparator: '\t',
                                    extension: '.tsv',
                                    title: function() {
                                        const chr = $('#enhancer_chr').val() || 'All';
                                        const enh = $('#enhancer_name').val() || '';
                                        const condition = $('#tab1_condition').val() || 'All';
                                        const name = enh || `${chr}_Region`;
                                        return `Enhancers_${name}_${condition}_${new Date().toISOString().split('T')[0]}`;
                                    }
                                },
                                {
                                    extend: 'excelHtml5',
                                    title: function() {
                                        const chr = $('#enhancer_chr').val() || 'All';
                                        const enh = $('#enhancer_name').val() || '';
                                        const condition = $('#tab1_condition').val() || 'All';
                                        const name = enh || `${chr}_Region`;
                                        return `Enhancers_${name}_${condition}_${new Date().toISOString().split('T')[0]}`;
                                    }
                                }
                            ],
                            pageLength: 15,
                            lengthMenu: [10, 15, 25, 50, 100],
                            order: [[0,'asc']],
                            pagingType: 'full_numbers'
                        });

                        $('html, body').animate({ scrollTop: $('#enhancer-results').offset().top - 100 }, 600);
                    });
                });

                // Tab 2: Gene→Enhancer
                $('#gene-form').submit(function(e){
                    e.preventDefault();
                    $.post(this.action, $(this).serialize())
                    .done(html => {
                        $('#gene-results').html(html);

                        if ($.fn.DataTable.isDataTable('#enhancerTable')) {
                            $('#enhancerTable').DataTable().clear().destroy();
                        }

                        setTimeout(() => {
                            $('#enhancerTable').DataTable({
                                dom: 'Blfrtip',
                                buttons: [
                                    {
                                        extend: 'csvHtml5',
                                        title: function() {
                                            const gene = $('#gene_symbol').val() || $('#gene_id').val() || 'Gene';
                                            const condition = $('#tab2_condition').val() || 'All';
                                            return `Gene_${gene}_Enhancers_${condition}_${new Date().toISOString().split('T')[0]}`;
                                        }
                                    },
                                    {
                                        extend: 'csvHtml5',
                                        text: 'TSV',
                                        fieldSeparator: '\t',
                                        extension: '.tsv',
                                        title: function() {
                                            const gene = $('#gene_symbol').val() || $('#gene_id').val() || 'Gene';
                                            const condition = $('#tab2_condition').val() || 'All';
                                            return `Gene_${gene}_Enhancers_${condition}_${new Date().toISOString().split('T')[0]}`;
                                        }
                                    },
                                    {
                                        extend: 'excelHtml5',
                                        title: function() {
                                            const gene = $('#gene_symbol').val() || $('#gene_id').val() || 'Gene';
                                            const condition = $('#tab2_condition').val() || 'All';
                                            return `Gene_${gene}_Enhancers_${condition}_${new Date().toISOString().split('T')[0]}`;
                                        }
                                    }
                                ],
                                pageLength: 15,
                                lengthMenu: [10, 15, 25, 50, 100],
                                order: [[3, 'desc']],
                                pagingType: 'full_numbers'
                            });

                            $('html, body').animate({ scrollTop: $('#gene-results').offset().top - 100 }, 600);
                        }, 300);
                    }).fail(() => alert('Search failed. Please try again.'));
                });

                // Tab 3: Activity Class Search
                $('#activity-form').submit(function(e){
                    e.preventDefault();
                    $.post(this.action, $(this).serialize())
                    .done(html => {
                        $('#activity-results').html(html);

                        if ($.fn.DataTable.isDataTable('#activityClassTable')) {
                            $('#activityClassTable').DataTable().clear().destroy();
                        }

                        setTimeout(() => {
                            if ($('#activityClassTable').length) {
                                $('#activityClassTable').DataTable({
                                    dom: 'Blfrtip',
                                    buttons: [
                                        {
                                            extend: 'csvHtml5',
                                            title: function() {
                                                const actClass = $('#tab3_activity_class').val() || 'All';
                                                const access = $('#tab3_accessibility').val() || 'All';
                                                return `ActivityClass_${actClass}_${access}_${new Date().toISOString().split('T')[0]}`;
                                            }
                                        },
                                        {
                                            extend: 'csvHtml5',
                                            text: 'TSV',
                                            fieldSeparator: '\t',
                                            extension: '.tsv',
                                            title: function() {
                                                const actClass = $('#tab3_activity_class').val() || 'All';
                                                const access = $('#tab3_accessibility').val() || 'All';
                                                return `ActivityClass_${actClass}_${access}_${new Date().toISOString().split('T')[0]}`;
                                            }
                                        },
                                        {
                                            extend: 'excelHtml5',
                                            title: function() {
                                                const actClass = $('#tab3_activity_class').val() || 'All';
                                                const access = $('#tab3_accessibility').val() || 'All';
                                                return `ActivityClass_${actClass}_${access}_${new Date().toISOString().split('T')[0]}`;
                                            }
                                        }
                                    ],
                                    pageLength: 15,
                                    lengthMenu: [10, 15, 25, 50, 100],
                                    order: [[0, 'asc']],
                                    pagingType: 'full_numbers',
                                    scrollX: true
                                });
                            }

                            $('html, body').animate({ scrollTop: $('#activity-results').offset().top - 100 }, 600);
                        }, 300);
                    }).fail(() => alert('Search failed. Please try again.'));
                });

                // Info box clicks
                $('#enhancerToGeneBox').click(function() {
                    $('.tab[data-target="#region-search"]').click();
                });
                $('#geneToEnhancerBox').click(function() {
                    $('.tab[data-target="#gene-search"]').click();
                });
            });
        </script>
    </body>
</html>
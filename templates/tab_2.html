{% if error_message %}
    <div style="color: #d32f2f; background-color: #ffebee; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
        {{ error_message }}
    </div>
{% endif %}

{% if enhancers %}
        <div id="activity_histogram" style="width: 100%; height: 400px; margin: 2rem 0;"></div>

    <!-- Store data -->
    <script id="histogram-data" type="application/json">
    {
        "scores":{{ enhancers | map(attribute='act_score') | list | tojson }}
    }
    </script>

    {% for e in enhancers %}
        {% if loop.first %}
        <!-- Gene Info (shown once) -->
        <table id="geneInfo">
          <tbody>
          <tr>
              <td rowspan="3"><strong>Gene Information</strong></td>
              <td></td>
              <td></td>
          </tr>
            <tr>
              <td><strong>Gene Symbol</strong></td>
              <td>{{ e.gene_symbol }}</td>
            </tr>
            <tr>
              <td><strong>Gene ID</strong></td>
              <td>{{ e.gene_id }}</td>
            </tr>
          <tr>
              <td rowspan="4"><strong>TPM Values</strong></td>
              <td></td>
              <td></td>
          </tr>
            <tr>
              <td><strong>Control</strong></td>
              <td>{{ e.tpm_ctrl }}</td>
            </tr>
            <tr>
              <td><strong>IMD</strong></td>
              <td>{{ e.tpm_imd }}</td>
            </tr>
            <tr>
              <td><strong>20E</strong></td>
              <td>{{ e.tpm_20e }}</td>
            </tr>
          </tbody>
        </table>

        <!-- Enhancer Table -->
        <table id="enhancerTable" class="display" style="width:100%; margin-top:1em;">
          <thead>
            <tr>
                <th>Enhancer Name</th>
                <th>Enhancer Length</th>
                <th>Accessibility</th>
                <th>Activity Score</th>
                <th>Condition</th>
            </tr>
          </thead>
          <tbody>
        {% endif %}

            <!-- Enhancer Row -->
            <tr>
                <td>
                    {% if e.chromosome and e.start and e.end %}
                        <a href="https://genome.ucsc.edu/s/lbcohen/immune_enhancers?position={{ e.chromosome }}:{{ e.window_start }}-{{ e.window_end }}" target="_blank">
                        {{ e.enhancer_id }}
                    </a>
                    {% else %}
                        {{ e.enhancer_id or 'N/A' }}
                    {% endif %}
                </td>
                <td>{{ e.en_length }}</td>
                <td>{{ e.accessibility or '-' }}</td>
                <td>{{ e.act_score or ('-' if e.act_score == 0) }}</td>
                <td>{{ e.exp_condition or '-' }}</td>
            </tr>

        {% if loop.last %}
          </tbody>
        </table>
        {% endif %}
    {% endfor %}

{% elif not error_message %}
    <p>No enhancers found matching your criteria.</p>

{% endif %}
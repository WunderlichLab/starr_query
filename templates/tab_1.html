<!DOCTYPE html>
{% if error_message %}
    <div style="color: #d32f2f; background-color: #ffebee; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
        {{ error_message }}
    </div>
{% endif %}

{% if enhancers %}
    <table id="geneTable" class="display" style="width: 100%;">
        <thead>
        <tr>
            <th>Enhancer ID</th>
            <th>Enhancer Length</th>
            <th>Experimental Condition</th>
            <th>Activity Score</th>
            <th>Gene Symbol</th>
            <th>Accessibility</th>
            <th>TPM Control</th>
            <th>TPM IMD</th>
            <th>TPM 20E</th>
            <th>Immune Process</th>
            <th>Time Cluster</th>
        </tr>
        </thead>

        <tbody>
        {% for e in enhancers %}
            {% set total_genes = e.conditions | map(attribute='genes') | map('length') | sum %}
            {% set condition_loop = loop %}
            {% for c in e.conditions %}
                {% set gene_loop = loop %}
                {% for g in c.genes %}
                    <tr>
                        {% if gene_loop.first and loop.first %}
                            <td rowspan="{{ total_genes }}">
                                <a href="https://genome.ucsc.edu/s/lbcohen/immune_enhancers?position={{ e.chromosome }}:{{ e.window_start }}-{{ e.window_end }}" target="_blank">
                                    {{ e.enhancer_id }}
                                </a>
                            </td>
                            <td rowspan="{{ total_genes }}">{{ e.en_length }}</td>
                        {% endif %}

                        {% if loop.first %}
                            <td rowspan="{{ c.genes|length }}">{{ c.exp_condition or '-' }}</td>
                            <td rowspan="{{ c.genes|length }}">{{ c.activity if c.activity else '-' }}</td>
                        {% endif %}

                        <td>{{ g.gene_symbol or g.gene_id or '-'}}</td>
                        <td>{{ g.accessibility or '-'}}</td>
                        <td>{{ '%.2f'|format(g.tpm_ctrl) if g.tpm_ctrl else '-'}}</td>
                        <td>{{ '%.2f'|format(g.tpm_imd) if g.tpm_imd else '-' }}</td>
                        <td>{{ '%.2f'|format(g.tpm_20e) if g.tpm_20e else '-' }}</td>
                        <td>{{ g.immune_process or '-' }}</td>
                        <td>{{ g.time_cluster or '-' }}</td>
                    </tr>
                {% endfor %}
            {% endfor %}
        {% endfor %}
        </tbody>
    </table>

{% elif not error_message %}
    <p>No enhancers found matching your criteria.</p>
{% endif %}
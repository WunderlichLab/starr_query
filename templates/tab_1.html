{% if error_message %}
    <div style="color: #d32f2f; background-color: #ffebee; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
        {{ error_message }}
    </div>
{% endif %}

{% if enhancers %}
    <div style="display: flex; gap: 2rem; margin: 2rem 0; flex-wrap: wrap;">
        <div id="condition_pie_chart" style="flex: 1; min-width: 400px; height: 400px;"></div>
    </div>

    <!-- Store data for chart -->
    <script id="chart-data" type="application/json">
    {
        "conditions":{{ enhancers | map(attribute='conditions') | list | tojson }}
    }
    </script>
    <table id="geneTable" class="display">
        <thead>
        <tr>
            <th rowspan="2">Enhancer ID</th>
            <th rowspan="2">Enhancer Length</th>
            <th rowspan="2">Experimental Condition</th>
            <th rowspan="2">Activity Score</th>
            <th rowspan="2">Gene Symbol</th>
            <th rowspan="2">Accessibility</th>
            <th colspan="3">TPM Values</th>
            <th rowspan="2">Immune Process</th>
            <th rowspan="2">Time Cluster</th>
        </tr>

        <tr>
            <th>Control</th>
            <th>IMD</th>
            <th>20E</th>
        </tr>
        </thead>

        <tbody>
        {% for e in enhancers %}
            {% set total_genes = e.conditions | map(attribute='genes') | map('length') | sum %}
            {% set condition_loop = loop %}
            {% for c in e.conditions %}
                {% set gene_loop = loop %}
                {% for g in c.genes %}
                    <tr>
                        {# Print enhancer-level info only on the very first row of this enhancer #}
                        {% if gene_loop.first and loop.first %}
                            <td rowspan="{{ total_genes }}">  <a href="https://genome.ucsc.edu/s/lbcohen/immune_enhancers?position={{ e.chromosome }}:{{ e.window_start }}-{{ e.window_end }}" target="_blank">
                                {{ e.enhancer_id }}
                            </a>
                            </td>
                            <td rowspan="{{ total_genes }}">{{ e.en_length }}</td>
                        {% endif %}

                        {# Print condition info only once per condition block #}
                        {% if loop.first %}
                            <td rowspan="{{ c.genes|length }}">{{ c.exp_condition or '-' }}</td>
                            <td rowspan="{{ c.genes|length }}">{{ c.activity or ('-' if c.activity == 0) }}</td>
                        {% endif %}

                        <td>{{ g.gene_symbol or g.gene_id or '-'}}</td>
                        <td>{{ g.accessibility or '-'}}</td>
                        <td>{{ g.tpm_ctrl or '-'}}</td>
                        <td>{{ g.tpm_imd or '-' }}</td>
                        <td>{{ g.tpm_20e or '-' }}</td>
                        <td>{{ g.immune_process or '-' }}</td>
                        <td>{{ g.time_cluster or '-' }}</td>
                    </tr>
                {% endfor %}
            {% endfor %}
        {% endfor %}
        </tbody>
    </table>

{% elif not error_message %}
    <p>No enhancers found matching your criteria.</p>
{% endif %}